[![Generic badge](https://img.shields.io/badge/python_version-3.7-blue.svg)](https://shields.io/)

## Introduction

### About GPS Tracker 

This python project uses a Raspberry Pi 3, an USB GPS Sensor and an RC522 RFID Card Reader in order to log GPS coordinates of specific routes. It's intended usage is for tracking and measuring route distances.

The user uses an RFID Card to start/stop the logging of GPS coordinates, a CSV file is automatically generated that stores the GPS coordinates in a _log format_.

### Equipment List

Below are all the devices and parts that are needed:
- __Raspberry Pi 2 or 3__ (with MicroSD Card and Power Supply)
- __RC522 RFID Reader__ + Card (and wires for connectivity)
- __USB GPS Sensor__ (NMEA Standard Compatible)
- __Power bank__ (to power the raspberry while moving)

### Wiring the system

The __RFID RC522__ has 8 ports and 7 of those we will wire to the Raspberry Pi's GPIO pins as following:
__SDA__(Serial Data Signal) to __Pin 24__, __SCK__(Serial Clock) to __Pin 23__, __MOSI__(Master Out Slave In) to __Pin 19__,
__MISO__(Master In Slave Out) to __Pin 21__, __IRQ__(Interrupt Request) is left unconnected, __GND__(Ground Power) to __Pin 6__,
__RST__(Reset-Circuit) to __Pin 22__, and __3.3V__(Power In) to __Pin 1__.

The __USB GPS Sensor__ will be connected to one of the Raspberry Pi's USB ports. The Raspbian OS will map that USB port
to a file in _/dev/_ folder.

### Setting up the Raspbian

#### Enable the SPI for RC522

Before we can run the script we must make sure the Raspberry is setup. First we must make changes to the
configuration. By default the Raspberry Pi has the SPI(Serial Peripheral Interface) disabled.

    sudo raspi-config
    
In the configuration menu we must chose '5 Interfacing Options' and then 'P4 SPI', press Enter and enable it.
After saving the changes you must reboot the Raspberry.
    
    sudo reboot

Once the Raspberry has finished rebooting you can check to make sure the SPI has been enabled by entering the following
command and to check if __spi_bcm2835__ is listed.

    lsmod | grep spi

#### Installing spidev and mfrc522 libraries

The following commands will update our Raspberry Pi and install python3-dev and python3-pip.

    sudo apt-get update
    sudo apt-get upgrade
    sudo apt-get install python3-dev python3-pip

After that we must install the spidev and mfrc522 libraries

    sudo pip3 install spidev
    sudo pip3 install mfrc522
    
#### Aditional libraries

We must install aditional libraries that are not part of the standard python libraries package.
These are __pyserial__, a library for serial port communications and __geopy__, a library that will
help us calculate the distance between GPS coordinates.

    sudo pip3 install pyserial
    sudo pip3 install geopy

### Implementation Details

#### Crontab and Launcher.sh

At boot time a crontab is configured to stard a _launcher.sh_ script that will in turn start our python
scripts. To setup the crontab simply type the following commands:

    sudo crontab -e
    
And after the crontab file openes add a line at the bottom:

    #Crontab file
    @reboot sh /path/to/laucher.sh > /path/to/logs/folder/crontab.log 2>&1
    
Make sure _launcher.sh_ has execute rights and reboot your Raspberry. Now the _launcher.sh_ script
should start automatically. Check the _crontab.log_ for possible errors.

#### Time Update script

After boot, the first python script that we run updates the Raspberry Pi's date and time with information
from the GPS Sensor. If the GPS device is disconnected the script will wait untill the device is reconnected.

#### Tracker script

After the Raspberry Pi has updated it's date and time (for logging consistency purposes) we start the
main tracking script. The script was implemented using threads, there is a worker thread that is listening
for RFID Card Readings and signals the Main thread to start logging the GPS data.

#### Cleanup.sh

This is a bash script that removes all the logs from their locations. This is implemented for testing purposes, to get rid of logs that we don't want and to clean the system.

### Logging

There are a series of logging mechanisms that are implemented. All the files are stored inside _logs_ 
folder in the main project folder:
-__System Logs__: are logs that are generated by:
    - tracker.log - logs information about _tracker.py_ script startup, card redings, journey state, debugging information and 
various errors
    - time_update.log - logs information about _time_update.py_ script startup, successfull date change and various errors
    - crontab - logs errors and information about _launcher.sh_ script
-__GPS Logs__: are logs that are related to the routes GPS data:
    - routes.log - logs all the routes in JSON format, each new route on a newline.
    - /routes/route_routeID_cardID.csv - logs all the intermediary GPS coordinates in a csv file.



#### GPS logs format

The global routes log, _route.log_ from _gps_logs_ folder logs the data in JSON format as following:

    {"route_id": 1, "timestamp_start": "2020-02-06T13:59:13Z", "lat_start": 44.424587, "lon_start": 26.053704, "user_id":   "142189814135", "timestamp_stop": "2020-02-06T14:01:40Z", "lat_stop": 44.422773, "lon_stop": 26.054524, "distance": 242}
    {"route_id": 2, "timestamp_start": "2020-02-06T14:02:14Z", "lat_start": 44.422534, "lon_start": 26.05434, "user_id": "780870559455", "timestamp_stop": "2020-02-06T14:05:00Z", "lat_stop": 44.424181, "lon_stop": 26.052981, "distance": 233}
    {"route_id": 3, "timestamp_start": "2020-02-06T14:05:17Z", "lat_start": "44.424358", "lon_start": "26.052915", "user_id": "142189814135", "timestamp_stop": "2020-02-06T14:08:53Z", "lat_stop": 44.424475, "lon_stop": 26.053901, "distance": 238}
    ...

The GPS coordinates are saved in a file that is generated automatically in the _gps_logs_ folder inside
the _logs_ folder. It's name is _route_routeID_cardID.csv_.

The CSV file contains the timestamp, latitude, longitude and total_distance.

    Timestamp           Latitude    Longitude   Total_Distance
    2020-02-06T13:59:14Z	44.424582	26.053711	0
    2020-02-06T13:59:15Z	44.424571	26.053722	1.5
    2020-02-06T13:59:16Z	44.424557	26.053733	3.29
    2020-02-06T13:59:17Z	44.424542	26.05374	5.05
    2020-02-06T13:59:18Z	44.424525	26.053744	6.97
    2020-02-06T13:59:19Z	44.424508	26.053749	8.9
    2020-02-06T13:59:20Z	44.424492	26.053753	10.71
    2020-02-06T13:59:21Z	44.424475	26.053755	12.61
    ...

### Features added

- using a card reader to start/stop the system
- configured logging files for debugging, information and errors
- script that automatically updates system time at startup
- implemented measurement of distance
- system robustness for GPS signal loss
- system robustness for Power Supply loss
- automatically resuming journey after power failure
- multiple cards management (rejection of foreign cards + only one card per route)
- aproximation of distance traveled in case of power failure or GPS signal loss
- global routes log that is used for generating route reports


### Features to be added

- implementing a KALMAN filter for better GPS data filtering (requires accelerometer data)
- adding a switch/button to prevent accidental card readings
- adding a buzzer/led indicator for better debugging
- adding a I2C LCD Scren as a user interface
- displaying userful information on LCD (state of journey, distance traveled, total distance traveled etc.)
- adding a buzzer tone in the case of movement without card readings (as fail-safe)
- database for card users and card id's
 
